<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å•è¯å¯¹å¯¹ç¢°ï½œGitHub CSVç›´è¿ç‰ˆï¼ˆä¿®å¤ç‰ˆï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}
body {
  background: linear-gradient(135deg, #f0f4ff, #d9e2ff);
  min-height: 100vh;
  padding: 24px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.card {
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 8px 30px rgba(0, 30, 80, 0.08);
  width: 100%;
  max-width: 720px;
  padding: 22px 24px;
  margin-bottom: 18px;
}
h2 {
  font-size: 20px;
  margin-bottom: 14px;
  color: #1d2939;
}
.btn {
  padding: 10px 18px;
  border-radius: 10px;
  border: none;
  background: #3b82f6;
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
  margin-right: 8px;
  margin-bottom: 8px;
}
.btn:hover {
  background: #2563eb;
}
.btn:disabled {
  background: #c5cde2;
  cursor: not-allowed;
}
.btn-red {
  background: #ef4444;
}
.btn-red:hover {
  background: #dc2626;
}
.btn-success {
  background: #10b981;
}
.btn-success:hover {
  background: #059669;
}
.btn-reset {
  background: #f59e0b;
}
.btn-reset:hover {
  background: #d97706;
}
.btn-link {
  background: #8b5cf6;
}
.btn-link:hover {
  background: #7c3aed;
}
.info {
  font-size: 14px;
  color: #4b5563;
  margin: 6px 0;
}
.status-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 18px;
}
.time {
  font-size: 20px;
  font-weight: 700;
  color: #ef4444;
}
.level-select {
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  font-size: 14px;
  margin-right: 8px;
}
.link-input {
  width: 100%;
  max-width: 500px;
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  font-size: 14px;
  margin: 10px 0;
  word-break: break-all;
}
.rows {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.word-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
}
.word-box {
  width: 49%;
  min-height: 52px;
  padding: 12px 14px;
  border-radius: 12px;
  border: 2px solid #e5e7eb;
  background: #fafbfc;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  font-size: 15px;
  cursor: pointer;
  transition: 0.2s;
  position: relative;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
.word-box.selected {
  border-color: #3b82f6;
  background: #eff6ff;
}
.word-box.matched {
  border-color: #10b981;
  background: #f0fdf4;
  color: #065f46;
  cursor: not-allowed;
}
.word-box.wrong {
  border-color: #ef4444;
  background: #fef2f2;
  color: #dc2626;
  animation: shake 0.4s;
}
@keyframes shake {
  0%,100%{transform:translateX(0);}25%{transform:translateX(-4px);}50%{transform:translateX(4px);}75%{transform:translateX(-4px);}
}
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
  pointer-events: auto;
}
.modal-content {
  background: white;
  border-radius: 16px;
  padding: 30px;
  max-width: 400px;
  width: 90%;
  text-align: center;
  position: relative;
  z-index: 1000;
}
#fileInput {
  display: none;
}
.hide {
  display: none !important;
}
</style>
</head>
<body>

<div class="card" id="uploadCard">
  <h2>ğŸ“š å•è¯å¯¹å¯¹ç¢°ï¼ˆGitHub CSVç›´è¿ï¼‰</h2>
  <!-- æœ¬åœ°ä¸Šä¼ è¯åº“ -->
  <button class="btn" id="selectFile">æœ¬åœ°é€‰æ‹© Excel / CSV</button>
  <input type="file" id="fileInput" accept=".xlsx,.csv">
  <div class="info" id="fileTip">æœªé€‰æ‹©æ–‡ä»¶ | ç²˜è´´GitHub CSVè¯åº“é“¾æ¥åœ¨çº¿åŠ è½½</div>
  
  <!-- åœ¨çº¿åŠ è½½è¯åº“é“¾æ¥ -->
  <div style="margin:15px 0;">
    <span style="font-size:14px; color:#4b5563;">GitHub CSVé“¾æ¥ï¼š</span>
    <input type="text" class="link-input" id="wordLinkInput" placeholder="ç²˜è´´ä½ çš„GitHub CSVåŸå§‹é“¾æ¥" value="https://github.com/anzhaha/memorize-words/raw/refs/heads/main/5500.csv">
    <button class="btn btn-link" id="loadLinkBtn">åœ¨çº¿åŠ è½½è¯åº“</button>
  </div>

  <div class="info">æ€»è¯æ•°ï¼š<span id="totalWords">0</span>ï½œæ€»å…³å¡ï¼š<span id="totalLevels">0</span></div>
  <div class="info" style="margin-top:10px">é”™è¯æ•°ï¼š<span id="wrongCount" style="color:#ef4444;font-weight:600">0</span></div>

  <div style="margin-top:16px;display:flex;align-items:center;flex-wrap:wrap;">
    <span style="margin-right:10px; font-size:14px;">é€‰æ‹©å…³å¡ï¼š</span>
    <select id="levelSelect" class="level-select" disabled></select>
    <button class="btn btn-success" id="startSelected" disabled>å¼€å§‹æ‰€é€‰å…³å¡</button>
    <button class="btn btn-reset" id="resetCurrent" disabled>é‡æ–°å¼€å§‹æœ¬å…³</button>
    <button class="btn btn-red" id="wrongPractice" disabled>é”™è¯é‡ç»ƒ</button>
  </div>
</div>

<div class="card" id="gameBox" style="display:none;">
  <div class="status-bar">
    <div class="time" id="timeTxt">01:45</div>
    <div id="levelTag" style="font-size:16px; font-weight:600;">å…³å¡ 1</div>
    <div id="progressTxt" style="font-size:14px; color:#4b5563;">è¿›åº¦ï¼š0 / 100</div>
  </div>

  <div class="rows">
    <div class="word-row"><div class="word-box en"></div><div class="word-box cn"></div></div>
    <div class="word-row"><div class="word-box en"></div><div class="word-box cn"></div></div>
    <div class="word-row"><div class="word-box en"></div><div class="word-box cn"></div></div>
    <div class="word-row"><div class="word-box en"></div><div class="word-box cn"></div></div>
    <div class="word-row"><div class="word-box en"></div><div class="word-box cn"></div></div>
  </div>
</div>

<!-- æ™®é€šå¼¹çª— -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h2 id="modalTitle"></h2>
    <p style="margin:14px 0; color:#6b7280;" id="modalMsg"></p>
    <button class="btn" id="modalClose">ç¡®å®š</button>
  </div>
</div>

<script>
const TIME_TOTAL = 105;
const PAIR_PER_LEVEL = 100;

let allWords = [];
let totalLevels = 0;
let currentLevel = 1;
let levelWords = [];
let queue = [];
let done = 0;
let timeLeft = TIME_TOTAL;
let timer = null;

let wrongSet = new Set();
let wrongList = [];
let isWrongMode = false;

// DOMå…ƒç´ 
const fileInput = document.getElementById('fileInput');
const selectFile = document.getElementById('selectFile');
const fileTip = document.getElementById('fileTip');
const totalWordsEl = document.getElementById('totalWords');
const totalLevelsEl = document.getElementById('totalLevels');
const wrongCountEl = document.getElementById('wrongCount');
const levelSelect = document.getElementById('levelSelect');
const startSelected = document.getElementById('startSelected');
const resetCurrent = document.getElementById('resetCurrent');
const wrongPractice = document.getElementById('wrongPractice');
const gameBox = document.getElementById('gameBox');
const timeTxt = document.getElementById('timeTxt');
const levelTag = document.getElementById('levelTag');
const progressTxt = document.getElementById('progressTxt');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalMsg = document.getElementById('modalMsg');
const modalClose = document.getElementById('modalClose');
const wordLinkInput = document.getElementById('wordLinkInput');
const loadLinkBtn = document.getElementById('loadLinkBtn');

const enBoxes = document.querySelectorAll('.word-box.en');
const cnBoxes = document.querySelectorAll('.word-box.cn');

// é¡µé¢åŠ è½½åˆå§‹åŒ–
window.onload = function() {
  initEvent();
};

// åˆå§‹åŒ–æ‰€æœ‰äº‹ä»¶
function initEvent() {
  // æœ¬åœ°æ–‡ä»¶ä¸Šä¼ 
  selectFile.onclick = () => fileInput.click();
  fileInput.onchange = handleLocalFile;
  // åœ¨çº¿åŠ è½½è¯åº“ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šåŒºåˆ†CSV/Excelï¼‰
  loadLinkBtn.onclick = handleLinkLoad;
  // å¼¹çª—å…³é—­
  modalClose.onclick = () => modal.style.display = "none";
  modal.onclick = (e) => e.target === modal && (modal.style.display = "none");
}

// å¤„ç†æœ¬åœ°æ–‡ä»¶ä¸Šä¼ ï¼ˆå…¼å®¹Excel/CSVï¼‰
function handleLocalFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  fileTip.textContent = "æ­£åœ¨è¯»å–ï¼š" + file.name;

  const reader = new FileReader();
  // æ ¹æ®æ–‡ä»¶åç¼€é€‰æ‹©è¯»å–æ–¹å¼ï¼šCSVè¯»æ–‡æœ¬ï¼ŒExcelè¯»äºŒè¿›åˆ¶
  const readMethod = file.name.endsWith('.csv') ? 'readAsText' : 'readAsArrayBuffer';
  reader[readMethod](file);

  reader.onload = (ev) => {
    try {
      let words = [];
      if (file.name.endsWith('.csv')) {
        // æœ¬åœ°CSVè§£æ
        words = parseCsvText(ev.target.result);
      } else {
        // æœ¬åœ°Excelè§£æ
        const wb = XLSX.read(ev.target.result);
        words = parseWorkbook(wb);
      }
      initWordData(words, file.name);
    } catch (e) {
      fileTip.textContent = "æœ¬åœ°æ–‡ä»¶è§£æå¤±è´¥";
      alert("æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼ï¼ˆen+cnä¸¤åˆ—è¡¨å¤´ï¼‰");
      console.error(e);
    }
  };
}

// æ ¸å¿ƒä¿®å¤ï¼šå¤„ç†åœ¨çº¿é“¾æ¥åŠ è½½ï¼ˆä¸“é—¨é€‚é…CSVçº¯æ–‡æœ¬è§£æï¼‰
function handleLinkLoad() {
  const link = wordLinkInput.value.trim();
  if (!link) {
    alert("è¯·å…ˆç²˜è´´GitHub CSVåŸå§‹é“¾æ¥ï¼");
    return;
  }
  // éªŒè¯æ˜¯å¦ä¸ºCSVé“¾æ¥
  if (!link.endsWith('.csv')) {
    alert("è¯·ç²˜è´´CSVæ ¼å¼çš„é“¾æ¥ï¼Œå½“å‰é“¾æ¥éCSVï¼");
    return;
  }
  fileTip.textContent = "æ­£åœ¨åœ¨çº¿åŠ è½½GitHub CSVè¯åº“...";
  loadLinkBtn.disabled = true;

  // ä»¥çº¯æ–‡æœ¬æ–¹å¼è¯·æ±‚CSVï¼ˆå…³é”®ï¼šä¸æ˜¯arrayBufferï¼‰
  fetch(link, {
    method: 'GET',
    mode: 'cors',
    headers: { 
      'Accept': 'text/plain, */*',
      'Cache-Control': 'no-cache'
    }
  }).then(res => {
    if (!res.ok) throw new Error(`ç½‘ç»œé”™è¯¯ï¼š${res.status}`);
    return res.text(); // æ ¸å¿ƒï¼šè¯»çº¯æ–‡æœ¬ï¼Œä¸æ˜¯äºŒè¿›åˆ¶
  }).then(csvText => {
    // è§£æCSVæ–‡æœ¬
    const words = parseCsvText(csvText);
    initWordData(words, "GitHubåœ¨çº¿CSVè¯åº“");
    showModal("âœ… åŠ è½½æˆåŠŸ", `å…±åŠ è½½ ${words.length} ä¸ªå•è¯ï¼Œå¯å¼€å§‹æ¸¸æˆï¼`);
  }).catch(e => {
    fileTip.textContent = "åœ¨çº¿åŠ è½½å¤±è´¥ï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¯¦æƒ…";
    alert(`åŠ è½½å¤±è´¥ï¼š${e.message}`);
    console.error("åœ¨çº¿åŠ è½½é”™è¯¯ï¼š", e);
  }).finally(() => {
    loadLinkBtn.disabled = false;
  });
}

// ç‹¬ç«‹çš„CSVæ–‡æœ¬è§£æå‡½æ•°ï¼ˆæ ¸å¿ƒï¼šå¤„ç†en/cnè¡¨å¤´ï¼Œè¿‡æ»¤ç©ºè¡Œï¼‰
function parseCsvText(csvText) {
  // æŒ‰è¡Œæ‹†åˆ†ï¼Œè¿‡æ»¤ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
  const lines = csvText.split(/\r?\n/).filter(line => line.trim() && !line.trim().startsWith('#'));
  if (lines.length < 1) throw new Error("CSVæ— æœ‰æ•ˆæ•°æ®");

  // è§£æè¡¨å¤´ï¼Œå…¼å®¹å‰åç©ºæ ¼
  const header = lines[0].split(',').map(item => item.trim());
  // éªŒè¯è¡¨å¤´æ˜¯å¦åŒ…å«enå’Œcnï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
  const enIndex = header.findIndex(h => h.toLowerCase() === 'en');
  const cnIndex = header.findIndex(h => h.toLowerCase() === 'cn');
  if (enIndex === -1 || cnIndex === -1) {
    throw new Error(`CSVè¡¨å¤´æ— æ•ˆï¼Œéœ€åŒ…å«enå’Œcnï¼Œå½“å‰è¡¨å¤´ï¼š${header.join(',')}`);
  }

  // è§£ææ•°æ®è¡Œ
  const words = [];
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    // æ‹†åˆ†åˆ—ï¼ˆå…¼å®¹ç®€å•çš„é€—å·åˆ†éš”ï¼Œé€‚é…ä½ çš„5500.csvï¼‰
    const cols = line.split(',').map(item => item.trim());
    // ç¡®ä¿åˆ—æ•°è¶³å¤Ÿï¼Œè¿‡æ»¤ç©ºå€¼
    if (cols.length > Math.max(enIndex, cnIndex) && cols[enIndex] && cols[cnIndex]) {
      words.push({
        en: cols[enIndex],
        cn: cols[cnIndex]
      });
    }
  }

  if (words.length === 0) throw new Error("CSVæ— æœ‰æ•ˆå•è¯æ•°æ®");
  return words;
}

// Excelå·¥ä½œç°¿è§£æï¼ˆåŸé€»è¾‘ï¼Œä¸å˜ï¼‰
function parseWorkbook(wb) {
  const ws = wb.Sheets[wb.SheetNames[0]];
  const json = XLSX.utils.sheet_to_json(ws, { header: ['en', 'cn'] });
  const list = [];
  json.forEach(row => {
    if (!row || !row.en || !row.cn) return;
    const en = String(row.en).trim();
    const cn = String(row.cn).trim();
    if (en && cn) list.push({ en, cn });
  });
  if (list.length === 0) throw new Error('Excelæ— æœ‰æ•ˆè¯åº“æ•°æ®');
  return list;
}

// è¯åº“æ•°æ®åˆå§‹åŒ–ï¼ˆæœ¬åœ°/åœ¨çº¿é€šç”¨ï¼‰
function initWordData(words, source) {
  allWords = words;
  totalWordsEl.textContent = allWords.length;
  totalLevels = Math.ceil(allWords.length / PAIR_PER_LEVEL);
  totalLevelsEl.textContent = totalLevels;
  fileTip.textContent = "å·²åŠ è½½ï¼š" + source;

  // åˆå§‹åŒ–å…³å¡é€‰æ‹©
  levelSelect.innerHTML = "";
  for (let i = 1; i <= totalLevels; i++) {
    const op = document.createElement("option");
    op.value = i;
    op.textContent = `ç¬¬ ${i} å…³`;
    levelSelect.appendChild(op);
  }
  // å¯ç”¨æ‰€æœ‰æŒ‰é’®
  levelSelect.disabled = false;
  startSelected.disabled = false;
  resetCurrent.disabled = false;
  wrongPractice.disabled = false;
  // ç»‘å®šæ¸¸æˆæ“ä½œäº‹ä»¶
  startSelected.onclick = () => {
    currentLevel = parseInt(levelSelect.value);
    isWrongMode = false;
    startLevel();
  };
  resetCurrent.onclick = () => levelWords.length && startLevel();
  wrongPractice.onclick = () => {
    if (wrongList.length === 0) return alert("æš‚æ— é”™è¯");
    isWrongMode = true;
    startLevel();
  };
}

// å¼€å§‹å…³å¡ï¼ˆåŸæ¸¸æˆé€»è¾‘ï¼Œæ— ä¿®æ”¹ï¼‰
function startLevel() {
  const from = (currentLevel - 1) * PAIR_PER_LEVEL;
  levelWords = isWrongMode ? [...wrongList] : allWords.slice(from, from + PAIR_PER_LEVEL);
  queue = [...levelWords];
  done = 0;
  timeLeft = TIME_TOTAL;

  gameBox.style.display = "block";
  clearInterval(timer);
  initBoard();
  updateUI();
  bindClicks();
  startTimer();
}

// åˆå§‹åŒ–æ¸¸æˆé¢æ¿
function initBoard() {
  enBoxes.forEach(b => { b.className = "word-box en"; b.textContent = ""; b.dataset.cn = ""; });
  cnBoxes.forEach(b => { b.className = "word-box cn"; b.textContent = ""; b.dataset.cn = ""; });

  const take = Math.min(5, queue.length);
  for (let i = 0; i < take; i++) {
    const word = queue.shift();
    enBoxes[i].textContent = word.en;
    enBoxes[i].dataset.cn = word.cn;
  }
  shuffleCn();
}

// æ‰“ä¹±ä¸­æ–‡é€‰é¡¹
function shuffleCn() {
  const vis = Array.from(enBoxes).filter(x => x.textContent);
  const cns = vis.map(x => x.dataset.cn);
  cns.sort(() => Math.random() - 0.5);
  vis.forEach((_, i) => {
    const txt = cns[i];
    const show = txt.length > 15 ? txt.substring(0, 15) + "â€¦" : txt;
    cnBoxes[i].textContent = show;
    cnBoxes[i].dataset.cn = txt;
    cnBoxes[i].className = "word-box cn";
  });
}

// è¡¥å……æ–°è¯
function refillRow(idx) {
  if (queue.length === 0) return;
  const w = queue.shift();
  const eb = enBoxes[idx];
  eb.textContent = w.en;
  eb.dataset.cn = w.cn;
  eb.classList.remove("matched");
  shuffleCn();
}

// ç»‘å®šå•è¯ç‚¹å‡»äº‹ä»¶
function bindClicks() {
  document.querySelectorAll(".word-box").forEach(box => {
    box.onclick = () => {
      if (box.classList.contains("matched")) return;
      const isEn = box.classList.contains("en");
      const list = isEn ? enBoxes : cnBoxes;
      list.forEach(b => b.classList.remove("selected"));
      box.classList.add("selected");

      const se = document.querySelector(".word-box.en.selected");
      const sc = document.querySelector(".word-box.cn.selected");
      if (!se || !sc) return;

      const real = se.dataset.cn;
      const user = sc.dataset.cn;
      const ok = real === user;

      if (!ok) {
        se.classList.add("wrong");
        sc.classList.add("wrong");
        const key = se.textContent;
        if (!wrongSet.has(key)) { 
          wrongSet.add(key); 
          wrongList.push({en:key, cn:real}); 
          wrongCountEl.textContent = wrongList.length; 
        }
        setTimeout(() => {
          se.classList.remove("wrong");
          sc.classList.remove("wrong");
          se.classList.remove("selected");
          sc.classList.remove("selected");
        }, 1000);
        return;
      }

      if (ok) {
        se.classList.add("matched");
        sc.classList.add("matched");
        se.classList.remove("selected");
        sc.classList.remove("selected");
        done++;
        updateUI();
        const idx = Array.from(enBoxes).indexOf(se);

        if (done >= levelWords.length) {
          clearInterval(timer);
          setTimeout(() => showModal(isWrongMode ? "é”™è¯é‡ç»ƒå®Œæˆ âœ…" : `ç¬¬ ${currentLevel} å…³é€šå…³ ğŸ‰`, "å¾ˆæ£’ï¼"), 300);
          return;
        }

        setTimeout(() => refillRow(idx), 300);
      }
    };
  });
}

// å¼€å§‹å€’è®¡æ—¶
function startTimer() {
  clearInterval(timer);
  timer = setInterval(() => {
    timeLeft--;
    updateTime();
    if (timeLeft <= 0) {
      clearInterval(timer);
      showModal("æ—¶é—´åˆ° â°", "æŒ‘æˆ˜å¤±è´¥");
    }
  }, 1000);
}

// æ›´æ–°æ—¶é—´æ˜¾ç¤º
function updateTime() {
  const m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
  const s = String(timeLeft % 60).padStart(2, '0');
  timeTxt.textContent = `${m}:${s}`;
}

// æ›´æ–°æ¸¸æˆUI
function updateUI() {
  updateTime();
  levelTag.textContent = isWrongMode ? "é”™è¯é‡ç»ƒæ¨¡å¼" : `å…³å¡ ${currentLevel}`;
  progressTxt.textContent = `è¿›åº¦ï¼š${done} / ${levelWords.length}`;
}

// æ˜¾ç¤ºå¼¹çª—
function showModal(title, msg) {
  modalTitle.textContent = title;
  modalMsg.textContent = msg;
  modal.style.display = "flex";
}
</script>
</body>
</html>